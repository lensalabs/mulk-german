---
import Layout from '../../layouts/Layout.astro';
import BottomNav from '../../components/BottomNav.astro';
import { SURAH_INFO } from '../../data/mulk-verses';
---

<Layout title="Einstellungen">
  <div class="min-h-screen flex flex-col bg-[var(--color-background)]">
    
    <!-- Header with gradient -->
    <header class="bg-gradient-to-b from-[#005086] via-[#318fb5] to-[#b0cac7] text-white px-4 pt-3 pb-16 safe-top">
      <div class="max-w-lg mx-auto flex items-center justify-between">
        <a href="/app" class="w-11 h-11 rounded-xl bg-white/10 flex items-center justify-center active:scale-95 transition-transform">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path></svg>
        </a>
        <div class="text-center">
          <h1 class="text-lg font-semibold tracking-tight">Einstellungen</h1>
          <p class="text-xs text-white/70">App personalisieren</p>
        </div>
        <div class="w-11"></div>
      </div>
    </header>

    <main class="flex-1 px-4 pb-28 -mt-12">
      <div class="max-w-lg mx-auto space-y-4">

        <!-- Account Section -->
        <div class="card">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-xl bg-[#b0cac7]/20 flex items-center justify-center">
              <svg class="w-5 h-5 text-[#005086]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
            </div>
            <div class="flex-1">
              <p class="font-semibold text-[var(--color-text)]" id="user-email">Wird geladen...</p>
              <p class="text-xs text-[var(--color-text-secondary)]">Dein Konto</p>
            </div>
          </div>
          
          <button id="logout-btn" class="w-full py-3 rounded-xl border border-[var(--color-border)] text-[var(--color-text-secondary)] font-medium flex items-center justify-center gap-2 hover:bg-[var(--color-background)] transition-colors active:scale-[0.98]">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
            Abmelden
          </button>
        </div>

        <!-- Reset Progress -->
        <div class="card">
          <button id="reset-btn" class="w-full flex items-center justify-between active:scale-[0.98] transition-all">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-xl bg-red-50 flex items-center justify-center">
                <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
              </div>
              <div class="text-left">
                <p class="font-semibold text-red-500">Fortschritt löschen</p>
                <p class="text-xs text-[var(--color-text-secondary)]">Von vorne beginnen</p>
              </div>
            </div>
            <svg class="w-5 h-5 text-[var(--color-text-secondary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
          </button>
        </div>

        <!-- Credits -->
        <div class="card">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-xl bg-[#318fb5]/10 flex items-center justify-center">
              <svg class="w-5 h-5 text-[#318fb5]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
            </div>
            <div>
              <p class="font-semibold text-[var(--color-text)]">Credits</p>
              <p class="text-xs text-[var(--color-text-secondary)]">Besonderer Dank</p>
            </div>
          </div>
          
          <div class="space-y-3">
            <div class="flex items-start gap-3">
              <div class="w-8 h-8 rounded-lg bg-[var(--color-primary)]/10 flex items-center justify-center flex-shrink-0 mt-0.5">
                <svg class="w-4 h-4 text-[var(--color-primary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
              </div>
              <div>
                <p class="text-sm font-medium text-[var(--color-text)]">Rezitator</p>
                <p class="text-sm text-[var(--color-text-secondary)]">Hfz. Sami Fetahu</p>
              </div>
            </div>
            
            <div class="flex items-start gap-3">
              <div class="w-8 h-8 rounded-lg bg-[#b0cac7]/30 flex items-center justify-center flex-shrink-0 mt-0.5">
                <svg class="w-4 h-4 text-[#005086]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path></svg>
              </div>
              <div>
                <p class="text-sm font-medium text-[var(--color-text)]">Übersetzung</p>
                <p class="text-sm text-[var(--color-text-secondary)]">Bubenheim/Elyas</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Report Bug / Feedback -->
        <div class="card">
          <a href="https://www.instagram.com/muslimmindset.de" target="_blank" rel="noopener noreferrer" class="flex items-center justify-between active:scale-[0.98] transition-all">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-[#833AB4] via-[#FD1D1D] to-[#F77737] flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
              </div>
              <div class="text-left">
                <p class="font-semibold text-[var(--color-text)]">Fehler melden</p>
                <p class="text-xs text-[var(--color-text-secondary)]">Schreib uns auf Instagram</p>
              </div>
            </div>
            <svg class="w-5 h-5 text-[var(--color-text-secondary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
          </a>
        </div>

        <!-- About -->
        <div class="card">
          <div class="flex items-center gap-3 mb-3">
            <div class="w-10 h-10 rounded-xl bg-[var(--color-border)]/50 flex items-center justify-center">
              <svg class="w-5 h-5 text-[var(--color-text-secondary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </div>
            <div>
              <p class="font-semibold text-[var(--color-text)]">Über Mulk 30</p>
              <p class="text-xs text-[var(--color-text-secondary)]">Version 1.0.0</p>
            </div>
          </div>
          <p class="text-sm text-[var(--color-text-secondary)] leading-relaxed">Eine 30-Tage Challenge um Sure Al-Mulk auswendig zu lernen.</p>
        </div>

      </div>
    </main>

    <BottomNav active="none" />

    <!-- Reset Confirmation Modal -->
    <div id="reset-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm p-4">
      <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-xl">
        <div class="text-center mb-6">
          <div class="w-14 h-14 mx-auto rounded-xl bg-red-50 flex items-center justify-center mb-4">
            <svg class="w-7 h-7 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>
          </div>
          <h3 class="text-lg font-bold text-[var(--color-text)]">Fortschritt löschen?</h3>
          <p class="text-sm text-[var(--color-text-secondary)] mt-2">Dies löscht den gesamten Fortschritt. Diese Aktion kann nicht rückgängig gemacht werden.</p>
        </div>
        <div class="flex gap-3">
          <button id="modal-cancel" class="flex-1 py-3 rounded-xl border border-[var(--color-border)] text-[var(--color-text)] font-medium">Abbrechen</button>
          <button id="modal-confirm" class="flex-1 py-3 rounded-xl bg-red-500 text-white font-medium">Löschen</button>
        </div>
      </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logout-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm p-4">
      <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-xl">
        <div class="text-center mb-6">
          <div class="w-14 h-14 mx-auto rounded-xl bg-[var(--color-primary)]/10 flex items-center justify-center mb-4">
            <svg class="w-7 h-7 text-[var(--color-primary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
          </div>
          <h3 class="text-lg font-bold text-[var(--color-text)]">Abmelden?</h3>
          <p class="text-sm text-[var(--color-text-secondary)] mt-2">Dein Fortschritt wird auf dem Gerät gespeichert.</p>
        </div>
        <div class="flex gap-3">
          <button id="logout-cancel" class="flex-1 py-3 rounded-xl border border-[var(--color-border)] text-[var(--color-text)] font-medium">Abbrechen</button>
          <button id="logout-confirm" class="flex-1 py-3 rounded-xl bg-[var(--color-primary)] text-white font-medium">Abmelden</button>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { getState, saveState } from '../../lib/challenge';
  import { getSession, supabase } from '../../lib/supabase';

  // Load user info
  (async () => {
    try {
      const { session } = await getSession();
      const emailEl = document.getElementById('user-email');
      if (session?.user?.email && emailEl) {
        emailEl.textContent = session.user.email;
      } else if (emailEl) {
        emailEl.textContent = 'Nicht angemeldet';
      }
    } catch (e) {
      const emailEl = document.getElementById('user-email');
      if (emailEl) emailEl.textContent = 'Nicht angemeldet';
    }
  })();

  // Reset progress modal
  const resetModal = document.getElementById('reset-modal')!;
  
  function showModal(modal: HTMLElement) {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }
  
  function hideModal(modal: HTMLElement) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }
  
  document.getElementById('reset-btn')?.addEventListener('click', () => {
    showModal(resetModal);
  });

  document.getElementById('modal-cancel')?.addEventListener('click', () => {
    hideModal(resetModal);
  });

  document.getElementById('modal-confirm')?.addEventListener('click', () => {
    const s = getState();
    s.completedDays = [];
    s.dayProgress = {};
    saveState(s);
    hideModal(resetModal);
    window.location.reload();
  });

  resetModal.addEventListener('click', (e) => {
    if (e.target === resetModal) hideModal(resetModal);
  });

  // Logout modal
  const logoutModal = document.getElementById('logout-modal')!;

  document.getElementById('logout-btn')?.addEventListener('click', () => {
    showModal(logoutModal);
  });

  document.getElementById('logout-cancel')?.addEventListener('click', () => {
    hideModal(logoutModal);
  });

  document.getElementById('logout-confirm')?.addEventListener('click', async () => {
    const btn = document.getElementById('logout-confirm') as HTMLButtonElement;
    const originalText = btn.textContent;
    
    btn.disabled = true;
    btn.textContent = 'Wird abgemeldet...';
    
    try {
      await supabase.auth.signOut();
      window.location.href = '/auth/login';
    } catch (e) {
      console.error('Logout failed:', e);
      btn.disabled = false;
      btn.textContent = originalText;
      window.location.href = '/auth/login';
    }
  });

  logoutModal.addEventListener('click', (e) => {
    if (e.target === logoutModal) hideModal(logoutModal);
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      hideModal(resetModal);
      hideModal(logoutModal);
    }
  });
</script>
