---
import Layout from '../../layouts/Layout.astro';
import BottomNav from '../../components/BottomNav.astro';
import { SURAH_INFO, MULK_VERSES } from '../../data/mulk-verses';
---

<Layout title="Dashboard">
  <div class="min-h-screen flex flex-col bg-[var(--color-background)]">
    
    <!-- Header with gradient + smooth transition -->
    <header class="bg-gradient-to-b from-[#005086] via-[#318fb5] to-[#b0cac7] text-white px-4 pt-3 pb-16 safe-top">
      <div class="max-w-lg mx-auto flex items-center justify-between">
        <img src="/logo-horizontal.svg" alt="Mulk 30" class="h-8 brightness-0 invert" />
        <a href="/app/settings" class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center active:scale-95 transition-transform" aria-label="Einstellungen">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
        </a>
      </div>
    </header>

    <!-- Main Content - pulls up into header gradient -->
    <main class="flex-1 px-4 pb-44 -mt-12">
      <div class="max-w-lg mx-auto space-y-4">

        <!-- HERO: Progress Circle + Current Day — Sand accent -->
        <div class="card text-center py-8 bg-gradient-to-b from-white to-[#f7d6bf]/30">
          <!-- Circular Progress Ring -->
          <div class="relative inline-flex items-center justify-center mb-4">
            <svg class="w-32 h-32 -rotate-90" viewBox="0 0 120 120">
              <!-- Background circle -->
              <circle cx="60" cy="60" r="52" fill="none" stroke="var(--color-border)" stroke-width="8"/>
              <!-- Progress circle -->
              <circle 
                id="progress-ring" 
                cx="60" 
                cy="60" 
                r="52" 
                fill="none" 
                stroke="var(--color-primary)" 
                stroke-width="8"
                stroke-linecap="round"
                stroke-dasharray="326.73"
                stroke-dashoffset="326.73"
                class="transition-all duration-700 ease-out"
              />
            </svg>
            <!-- Center content -->
            <div class="absolute inset-0 flex flex-col items-center justify-center">
              <span id="current-day-num" class="text-4xl font-bold text-[var(--color-primary)]">1</span>
              <span class="text-xs text-[var(--color-text-secondary)] uppercase tracking-wider">Tag</span>
            </div>
          </div>
          
          <!-- Progress Text -->
          <div class="mb-2">
            <p class="text-lg font-semibold text-[var(--color-text)]" id="progress-label">Beginn der Reise</p>
            <p class="text-sm text-[var(--color-text-secondary)]" id="progress-subtitle">Lerne den ersten Vers der Sure Al-Mulk</p>
          </div>
          
          <!-- Streak Badge (if active) -->
          <div id="streak-badge" class="hidden inline-flex items-center gap-1.5 bg-gradient-to-r from-[#318fb5]/15 to-[#b0cac7]/20 text-[#005086] px-3 py-1.5 rounded-full text-sm font-medium mt-2 shadow-sm border border-[#318fb5]/25">
            <svg class="w-5 h-5 text-[#318fb5] heartbeat" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>
            <span id="streak-text">0 Tage in Folge</span>
          </div>
        </div>

        <!-- PRIMARY CTA: Continue Learning Button - THUMB ZONE -->
        <a id="continue-btn" href="/app/day/1" class="block w-full bg-gradient-to-r from-[var(--color-primary)] to-[var(--color-primary-dark)] hover:from-[var(--color-primary-light)] hover:to-[var(--color-primary)] text-white text-center font-semibold py-5 px-6 rounded-2xl active:scale-[0.98] transition-all shadow-lg shadow-[#318fb5]/35 hover:shadow-xl hover:shadow-[#318fb5]/45 hover:-translate-y-0.5">
          <div class="flex items-center justify-center gap-3">
            <span id="cta-text">Loslegen</span>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
            </svg>
          </div>
        </a>

        <!-- RECOMMENDED: Daily Surah Listen - 10x -->
        <a href="/app/repeat?preset=daily" class="block w-full bg-gradient-to-r from-[#005086] to-[#318fb5] text-white font-semibold py-4 px-5 rounded-2xl active:scale-[0.98] transition-all shadow-md">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072M18.364 5.636a9 9 0 010 12.728M6.5 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h2.5l4-4v14l-4-4z"></path>
                </svg>
              </div>
              <div class="text-left">
                <p class="text-sm font-semibold">Ganze Sure anhören</p>
                <p class="text-xs text-white/70">Empfohlen: 10x täglich</p>
              </div>
            </div>
            <svg class="w-5 h-5 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </div>
        </a>

        <!-- Today's Step Status (Compact) -->
        <div id="today-steps-card" class="card">
          <div class="flex items-center justify-between mb-3">
            <span class="text-sm font-medium text-[var(--color-text)]">Tagesfortschritt</span>
            <span class="text-xs text-[var(--color-text-secondary)]" id="today-progress-text">0/3 Schritte</span>
          </div>
          <div class="flex items-center gap-3">
            <!-- Listen — Sage tint -->
            <div id="step-listen" class="flex-1 text-center p-3 rounded-xl bg-[#b0cac7]/15 border border-[#b0cac7]/30">
              <div class="w-8 h-8 mx-auto mb-1 rounded-lg bg-[#b0cac7]/30 flex items-center justify-center">
                <svg class="w-4 h-4 text-[#005086]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072M18.364 5.636a9 9 0 010 12.728M6.5 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h2.5l4-4v14l-4-4z"></path>
                </svg>
              </div>
              <span class="text-xs text-[var(--color-text-secondary)]" id="listen-status">0/10</span>
            </div>
            <!-- Read — Teal tint -->
            <div id="step-read" class="flex-1 text-center p-3 rounded-xl bg-[#318fb5]/10 border border-[#318fb5]/25">
              <div class="w-8 h-8 mx-auto mb-1 rounded-lg bg-[#318fb5]/20 flex items-center justify-center">
                <svg class="w-4 h-4 text-[#318fb5]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                </svg>
              </div>
              <span class="text-xs text-[var(--color-text-secondary)]" id="read-status">0/10</span>
            </div>
            <!-- Recite — Ocean/Deep tint -->
            <div id="step-recite" class="flex-1 text-center p-3 rounded-xl bg-[#005086]/10 border border-[#005086]/25">
              <div class="w-8 h-8 mx-auto mb-1 rounded-lg bg-[#005086]/20 flex items-center justify-center">
                <svg class="w-4 h-4 text-[#005086]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
              </div>
              <span class="text-xs text-[var(--color-text-secondary)]" id="recite-status">0/10</span>
            </div>
          </div>
        </div>

        <!-- Motivation Quote (changes based on progress) -->
        <div id="motivation-card" class="text-center py-4">
          <p class="text-sm text-[var(--color-text-secondary)] italic" id="motivation-text">
            "Wer Sure Al-Mulk jede Nacht liest, wird vor der Strafe des Grabes geschützt."
          </p>
          <p class="text-xs text-[var(--color-text-secondary)] mt-1">— Hadith</p>
        </div>

        <!-- Gift/Reward Banner -->
        <a href="/app/gift" class="block card bg-gradient-to-r from-[#f7d6bf]/40 to-[#b0cac7]/30 border-[#318fb5]/20">
          <div class="flex items-center gap-4">
            <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-yellow-400 to-orange-400 flex items-center justify-center shadow-md">
              <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 00-5.5-1.65l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 11 8.76l1-1.36 1 1.36L15.38 12 17 10.83 14.92 8H20v6z"/>
              </svg>
            </div>
            <div class="flex-1">
              <p class="font-semibold text-[var(--color-text)]">Gewinne ein Geschenk!</p>
              <p class="text-xs text-[var(--color-text-secondary)]">Schließe die 30-Tage Challenge ab und erhalte deine Belohnung</p>
            </div>
            <svg class="w-5 h-5 text-[var(--color-text-secondary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </div>
        </a>

      </div>
    </main>

    <!-- Bottom Nav -->
    <BottomNav active="home" />
  </div>
</Layout>

<style>
  /* Step completed state */
  .step-done {
    border-color: var(--color-primary) !important;
  }
  
  .step-done svg {
    color: var(--color-primary) !important;
  }

  /* Progress ring glow effect */
  #progress-ring {
    filter: drop-shadow(0 0 8px var(--color-primary)) drop-shadow(0 0 16px rgba(49, 143, 181, 0.4));
  }

  /* Heartbeat animation - plays 3 times then stops (better for battery) */
  .heartbeat {
    animation: heartbeat 1.2s ease-in-out 3;
  }
  
  @keyframes heartbeat {
    0%, 100% { transform: scale(1); }
    14% { transform: scale(1.2); }
    28% { transform: scale(1); }
    42% { transform: scale(1.15); }
    70% { transform: scale(1); }
  }

  /* Step cards subtle hover */
  #step-listen:hover, #step-read:hover, #step-recite:hover {
    background-color: var(--color-surface) !important;
    box-shadow: 0 2px 8px rgba(0, 80, 134, 0.15);
    transform: scale(1.02);
    transition: all 0.15s ease;
  }
</style>

<script>
  import { getState, getCurrentDay, getStreak, getProgress, isDayCompleted, getDayProgress, REQUIRED_COUNT, initializeState } from '../../lib/challenge';
  import { getSession, supabase } from '../../lib/supabase';

  // Auth guard + initialize state from cloud
  (async () => {
    try {
      // First check if we have a session in Supabase
      const { session } = await getSession();
      const isGuestMode = localStorage.getItem('mulk30_guest_mode') === 'true';
      
      console.log('[Auth] Session:', session ? 'exists' : 'none', 'Guest:', isGuestMode);
      
      if (!session && !isGuestMode) {
        console.log('[Auth] No session and no guest mode, redirecting to /');
        window.location.href = '/';
        return;
      }
      
      // Load progress from Supabase (or sync local → cloud)
      // Skip cloud sync for guest mode without session
      if (session) {
        await initializeState();
      }
      updateUI();
    } catch (e) {
      console.error('[Auth] Init error:', e);
      // Allow offline usage if guest mode
      const isGuestMode = localStorage.getItem('mulk30_guest_mode') === 'true';
      if (isGuestMode) {
        updateUI();
      } else {
        window.location.href = '/';
      }
    }
  })();

  function updateUI() {
    const state = getState();
    const day = getCurrentDay(state);
    const streak = getStreak(state);
    const progress = getProgress(state);
    const completedCount = state.completedDays.length;
    const dayProgress = getDayProgress(day);
    const dayCompleted = isDayCompleted(day);

    // Update circular progress ring
    const ring = document.getElementById('progress-ring') as SVGCircleElement;
    const circumference = 326.73; // 2 * π * 52
    const offset = circumference - (progress / 100) * circumference;
    ring.style.strokeDashoffset = String(offset);

    // Update current day number
    document.getElementById('current-day-num')!.textContent = String(day);

    // Update progress label based on completion
    const progressLabel = document.getElementById('progress-label')!;
    const progressSubtitle = document.getElementById('progress-subtitle')!;
    
    if (completedCount === 0) {
      progressLabel.textContent = 'Beginn der Reise';
      progressSubtitle.textContent = 'Lerne den ersten Vers der Sure Al-Mulk';
    } else if (completedCount < 7) {
      progressLabel.textContent = `${completedCount} Verse gelernt`;
      progressSubtitle.textContent = 'Erste Woche — weiter so!';
    } else if (completedCount < 15) {
      progressLabel.textContent = `${completedCount} Verse gelernt`;
      progressSubtitle.textContent = 'Du baust eine gute Gewohnheit auf!';
    } else if (completedCount < 22) {
      progressLabel.textContent = `${completedCount} Verse gelernt`;
      progressSubtitle.textContent = 'Über die Hälfte! Bleib dran!';
    } else if (completedCount < 30) {
      progressLabel.textContent = `${completedCount} Verse gelernt`;
      progressSubtitle.textContent = 'Das Ende naht! Nur noch wenige Tage!';
    } else {
      progressLabel.textContent = 'Masha\'Allah!';
      progressSubtitle.textContent = 'Du hast Sure Al-Mulk abgeschlossen!';
    }

    // Streak badge
    const streakBadge = document.getElementById('streak-badge')!;
    const streakText = document.getElementById('streak-text')!;
    if (streak > 0) {
      streakBadge.classList.remove('hidden');
      streakText.textContent = `${streak} Tage in Folge`;
    } else {
      streakBadge.classList.add('hidden');
    }

    // Update CTA button
    const continueBtn = document.getElementById('continue-btn') as HTMLAnchorElement;
    const ctaText = document.getElementById('cta-text')!;
    continueBtn.href = `/app/day/${day}`;
    
    if (completedCount === 0) {
      ctaText.textContent = 'Loslegen';
    } else if (dayCompleted) {
      if (day < 30) {
        ctaText.textContent = `Weiter mit Tag ${day + 1}`;
        continueBtn.href = `/app/day/${day + 1}`;
      } else {
        ctaText.textContent = 'Challenge überprüfen';
      }
    } else {
      ctaText.textContent = `Tag ${day} fortsetzen`;
    }

    // Update today's steps
    document.getElementById('listen-status')!.textContent = `${Math.min(dayProgress.listenCount, REQUIRED_COUNT)}/${REQUIRED_COUNT}`;
    document.getElementById('read-status')!.textContent = `${Math.min(dayProgress.readCount, REQUIRED_COUNT)}/${REQUIRED_COUNT}`;
    document.getElementById('recite-status')!.textContent = `${Math.min(dayProgress.reciteCount, REQUIRED_COUNT)}/${REQUIRED_COUNT}`;

    // Calculate completed steps
    const stepsCompleted = 
      (dayProgress.listenCount >= REQUIRED_COUNT ? 1 : 0) +
      (dayProgress.readCount >= REQUIRED_COUNT ? 1 : 0) +
      (dayProgress.reciteCount >= REQUIRED_COUNT ? 1 : 0);
    document.getElementById('today-progress-text')!.textContent = `${stepsCompleted}/3 Schritte`;

    // Style completed steps
    if (dayProgress.listenCount >= REQUIRED_COUNT) {
      document.getElementById('step-listen')!.classList.add('step-done');
    }
    if (dayProgress.readCount >= REQUIRED_COUNT) {
      document.getElementById('step-read')!.classList.add('step-done');
    }
    if (dayProgress.reciteCount >= REQUIRED_COUNT) {
      document.getElementById('step-recite')!.classList.add('step-done');
    }

    // Hide today's steps card if challenge complete
    if (completedCount === 30) {
      document.getElementById('today-steps-card')!.classList.add('hidden');
    }
  }

  // Initial render (will be updated after cloud sync)
  updateUI();
</script>
